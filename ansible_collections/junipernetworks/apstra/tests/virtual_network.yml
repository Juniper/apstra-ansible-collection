---
- name: Test create/update/delete virtual_network
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:
    - name: Connect to Apstra
      junipernetworks.apstra.authenticate:
        logout: false
      register: auth

    - name: Create blueprint
      junipernetworks.apstra.blueprint:
        body:
          label: "test_blueprint"
          design: "two_stage_l3clos"
        lock_state: "locked"
        auth_token: "{{ auth.token }}"
      register: bp

    - name: Show created blueprint
      ansible.builtin.debug:
        var: bp

    - name: Create virtual_network
      junipernetworks.apstra.virtual_network:
        id: "{{ bp.id }}"
        body:
          label: "test_virtual_network"
          description: "test VN description"
          ipv4_enabled: true
          virtual_gateway_ipv4_enabled: true
          vn_id: "16777214"
          vn_type: "vxlan"
        auth_token: "{{ auth.token }}"
      register: vn

    - name: Show created virtual_network
      ansible.builtin.debug:
        var: vn

    - name: Modify virtual_network
      junipernetworks.apstra.virtual_network:
        id: "{{ vn.id }}"
        body:
          description: "test VN description edwin wuz here"
        auth_token: "{{ auth.token }}"

    - name: Commit the blueprint
      junipernetworks.apstra.blueprint:
        id: "{{ bp.id }}"
        lock_state: "ignore"
        state: committed
        auth_token: "{{ auth.token }}"
      register: blueprint_commit

    - name: Show committed blueprint
      ansible.builtin.debug:
        var: blueprint_commit

    - name: Delete the virtual_network
      junipernetworks.apstra.virtual_network:
        id: "{{ vn.id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: vn_delete

    - name: Show deleted virtual_network
      ansible.builtin.debug:
        var: vn_delete

    - name: Commit and unlock blueprint
      junipernetworks.apstra.blueprint:
        id: "{{ bp.id }}"
        lock_state: "unlocked"
        state: committed
        auth_token: "{{ auth.token }}"
      register: blueprint_unlock

    - name: Show unlocked blueprint
      ansible.builtin.debug:
        var: blueprint_unlock

    - name: Delete blueprint
      junipernetworks.apstra.blueprint:
        id: "{{ bp.id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: blueprint_delete

    - name: Show deleted blueprint
      ansible.builtin.debug:
        var: blueprint_delete

    - name: Logout of Apstra
      junipernetworks.apstra.authenticate:
        logout: true
        auth_token: "{{ auth.token }}"
