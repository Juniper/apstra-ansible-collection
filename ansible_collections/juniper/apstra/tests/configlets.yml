---
- name: Test configlets CRUD operations
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:
    - name: Get local hostname
      ansible.builtin.command: hostname
      register: local_hostname
      changed_when: false

    - name: Set blueprint name fact
      ansible.builtin.set_fact:
        blueprint_name: "test_configlets_{{ local_hostname.stdout }}"

    - name: Connect to Apstra
      juniper.apstra.authenticate:
        logout: false
      register: auth

    - name: Create blueprint
      juniper.apstra.blueprint:
        body:
          label: "{{ blueprint_name }}"
          design: "two_stage_l3clos"
        lock_state: "ignore"
        auth_token: "{{ auth.token }}"
      register: bp

    - name: Show created blueprint
      ansible.builtin.debug:
        var: bp

    # ── Catalog Configlet Tests ─────────────────────────────────────────

    - name: Create catalog configlet
      juniper.apstra.configlets:
        type: catalog
        body:
          display_name: "test_catalog_snmp"
          ref_archs:
            - "two_stage_l3clos"
          generators:
            - config_style: "junos"
              section: "system"
              template_text: "snmp {\n  community public;\n}"
              negation_template_text: ""
              filename: ""
        auth_token: "{{ auth.token }}"
      register: catalog_create

    - name: Display created catalog configlet
      ansible.builtin.debug:
        var: catalog_create

    - name: Create same catalog configlet again (should not change)
      juniper.apstra.configlets:
        type: catalog
        body:
          display_name: "test_catalog_snmp"
          ref_archs:
            - "two_stage_l3clos"
          generators:
            - config_style: "junos"
              section: "system"
              template_text: "snmp {\n  community public;\n}"
              negation_template_text: ""
              filename: ""
        auth_token: "{{ auth.token }}"
      register: catalog_no_change

    - name: Verify catalog configlet no change occurred
      ansible.builtin.assert:
        that:
          - not catalog_no_change.changed

    - name: Update catalog configlet
      juniper.apstra.configlets:
        type: catalog
        id: "{{ catalog_create.id }}"
        body:
          display_name: "test_catalog_snmp_updated"
          ref_archs:
            - "two_stage_l3clos"
          generators:
            - config_style: "junos"
              section: "system"
              template_text: "snmp {\n  community private;\n}"
              negation_template_text: ""
              filename: ""
        auth_token: "{{ auth.token }}"
      register: catalog_update

    - name: Display updated catalog configlet
      ansible.builtin.debug:
        var: catalog_update

    - name: Delete catalog configlet
      juniper.apstra.configlets:
        type: catalog
        id: "{{ catalog_create.id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: catalog_delete

    - name: Display delete result
      ansible.builtin.debug:
        var: catalog_delete

    - name: Delete same catalog configlet again (should not change)
      juniper.apstra.configlets:
        type: catalog
        id: "{{ catalog_create.id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: catalog_delete_again

    - name: Verify catalog delete idempotency
      ansible.builtin.assert:
        that:
          - not catalog_delete_again.changed

    # ── Blueprint Configlet Tests ───────────────────────────────────────

    - name: Create blueprint configlet
      juniper.apstra.configlets:
        type: blueprint
        id:
          blueprint: "{{ bp.id.blueprint }}"
        body:
          label: "test_bp_snmp"
          condition: 'role in ["leaf"]'
          configlet:
            display_name: "test_bp_snmp"
            generators:
              - config_style: "junos"
                section: "system"
                template_text: "snmp {\n  community bp-public;\n}"
                negation_template_text: ""
                filename: ""
        auth_token: "{{ auth.token }}"
      register: bp_create

    - name: Display created blueprint configlet
      ansible.builtin.debug:
        var: bp_create

    - name: Create same blueprint configlet again (should not change)
      juniper.apstra.configlets:
        type: blueprint
        id:
          blueprint: "{{ bp.id.blueprint }}"
        body:
          label: "test_bp_snmp"
          condition: 'role in ["leaf"]'
          configlet:
            display_name: "test_bp_snmp"
            generators:
              - config_style: "junos"
                section: "system"
                template_text: "snmp {\n  community bp-public;\n}"
                negation_template_text: ""
                filename: ""
        auth_token: "{{ auth.token }}"
      register: bp_no_change

    - name: Verify blueprint configlet no change occurred
      ansible.builtin.assert:
        that:
          - not bp_no_change.changed

    - name: Update blueprint configlet
      juniper.apstra.configlets:
        type: blueprint
        id:
          blueprint: "{{ bp.id.blueprint }}"
          configlet: "{{ bp_create.id.configlet }}"
        body:
          label: "test_bp_snmp"
          condition: 'role in ["leaf", "spine"]'
          configlet:
            display_name: "test_bp_snmp"
            generators:
              - config_style: "junos"
                section: "system"
                template_text: "snmp {\n  community bp-private;\n}"
                negation_template_text: ""
                filename: ""
        auth_token: "{{ auth.token }}"
      register: bp_update

    - name: Display updated blueprint configlet
      ansible.builtin.debug:
        var: bp_update

    - name: Delete blueprint configlet
      juniper.apstra.configlets:
        type: blueprint
        id:
          blueprint: "{{ bp.id.blueprint }}"
          configlet: "{{ bp_create.id.configlet }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: bp_delete

    - name: Display blueprint delete result
      ansible.builtin.debug:
        var: bp_delete

    - name: Delete same blueprint configlet again (should not change)
      juniper.apstra.configlets:
        type: blueprint
        id:
          blueprint: "{{ bp.id.blueprint }}"
          configlet: "{{ bp_create.id.configlet }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: bp_delete_again

    - name: Verify blueprint delete idempotency
      ansible.builtin.assert:
        that:
          - not bp_delete_again.changed

    # ── Cleanup ─────────────────────────────────────────────────────────

    - name: Unlock the blueprint
      juniper.apstra.blueprint:
        id: "{{ bp.id }}"
        lock_state: "unlocked"
        auth_token: "{{ auth.token }}"
      register: blueprint_unlock

    - name: Show unlocked blueprint
      ansible.builtin.debug:
        var: blueprint_unlock

    - name: Delete blueprint
      juniper.apstra.blueprint:
        id: "{{ bp.id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: blueprint_delete

    - name: Show deleted blueprint
      ansible.builtin.debug:
        var: blueprint_delete

    - name: Logout of Apstra
      juniper.apstra.authenticate:
        logout: true
        auth_token: "{{ auth.token }}"
