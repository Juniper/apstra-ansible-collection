---
# ═══════════════════════════════════════════════════════════════════
#  generic_systems test playbook
#
#  Run modes:
#    1) Standalone (creates & destroys its own blueprint):
#         make test-generic_systems
#         # or directly:
#         pipenv run ansible-playbook -v .../tests/generic_systems.yml
#
#    2) Existing blueprint (user provides ALL infrastructure details):
#         make test-generic_systems-bp \
#           BLUEPRINT_ID=<id> \
#           LEAF_SWITCH_ID=<leaf-node-id> \
#           IF_NAME_1=<interface1> \
#           IF_NAME_2=<interface2> \
#           IF_NAME_3=<interface3> \
#           IF_NAME_4=<interface4> \
#           IF_TRANSFORM_ID=<transform-id>
#
#         # or directly:
#         pipenv run ansible-playbook -v .../tests/generic_systems.yml \
#           -e use_existing_blueprint=true \
#           -e blueprint_id=<id> \
#           -e leaf_switch_id=<leaf-node-id> \
#           -e if_name_1=ge-0/0/3 \
#           -e if_name_2=ge-0/0/4 \
#           -e if_name_3=ge-0/0/5 \
#           -e if_name_4=ge-0/0/6 \
#           -e

#
#  Required extra vars for existing blueprint mode:
#    blueprint_id        - Blueprint UUID
#    leaf_switch_id      - Node ID of the leaf switch in the blueprint
#    if_name_1           - Free interface for single-link tests (Tests 1-8)
#    if_name_2           - Free interface for LAG link 1 (Test 9-11)
#    if_name_3           - Free interface for LAG link 2 (Test 9-11)
#    if_name_4           - Free interface for delete-by-name test (Test 18)
#    if_transform_id     - Interface transform ID (usually 1)
# ═══════════════════════════════════════════════════════════════════
- name: Test generic_systems CRUD operations
  hosts: localhost
  gather_facts: false
  connection: local
  vars:
    apstra_api_url: "{{ lookup('env', 'APSTRA_API_URL') }}"
    use_existing_blueprint: false
  tasks:
    - name: Get local hostname
      ansible.builtin.command: hostname
      register: local_hostname
      changed_when: false

    - name: Set blueprint name fact
      ansible.builtin.set_fact:
        blueprint_name: "test_generic_systems_{{ local_hostname.stdout }}"
      when: not use_existing_blueprint | bool

    - name: Connect to Apstra
      juniper.apstra.authenticate:
        logout: false
      register: auth

    # ══════════════════════════════════════════════════════════════════
    #  Blueprint Setup
    # ══════════════════════════════════════════════════════════════════

    - name: Create blueprint
      juniper.apstra.blueprint:
        body:
          label: "{{ blueprint_name }}"
          design: "two_stage_l3clos"
          init_type: "template_reference"
          template_id: "L2_Virtual_EVPN"
        lock_state: "ignore"
        auth_token: "{{ auth.token }}"
      register: bp
      when: not use_existing_blueprint | bool

    - name: Show created blueprint
      ansible.builtin.debug:
        var: bp
      when: not use_existing_blueprint | bool

    - name: Set blueprint_id fact
      ansible.builtin.set_fact:
        blueprint_id: "{{ bp.id.blueprint }}"
      when: not use_existing_blueprint | bool

    - name: Show blueprint_id being used
      ansible.builtin.debug:
        msg: "Using blueprint_id={{ blueprint_id }}"

    # ── Discover leaves and assign interface maps ──────────────────

    - name: Query leaves via QE
      ansible.builtin.uri:
        url: "{{ apstra_api_url }}/blueprints/{{ blueprint_id }}/qe"
        method: POST
        headers:
          AuthToken: "{{ auth.token }}"
        body_format: json
        body:
          query: "node('system', role='leaf', name='leaf')"
        validate_certs: false
        status_code: 200
      register: leaves_qe
      when: not use_existing_blueprint | bool

    - name: Extract leaf IDs
      ansible.builtin.set_fact:
        leaf_ids: "{{ leaves_qe.json['items'] | map(attribute='leaf') | map(attribute='id') | list }}"
      when: not use_existing_blueprint | bool

    - name: Display leaf IDs
      ansible.builtin.debug:
        msg: "Found {{ leaf_ids | length }} leaves: {{ leaf_ids }}"
      when: not use_existing_blueprint | bool

    - name: Build interface map assignment body
      ansible.builtin.set_fact:
        imap_body:
          assignments: "{{ {leaf_ids[0]: 'Juniper_vQFX__AOS-7x10-Leaf'} }}"
      when: not use_existing_blueprint | bool

    - name: Assign interface map to test leaf
      ansible.builtin.uri:
        url: "{{ apstra_api_url }}/blueprints/{{ blueprint_id }}/interface-map-assignments"
        method: PATCH
        headers:
          AuthToken: "{{ auth.token }}"
        body_format: json
        body: "{{ imap_body }}"
        validate_certs: false
        status_code: [200, 202, 204]
      register: imap_assign
      when: not use_existing_blueprint | bool

    - name: Display interface map assignment result
      ansible.builtin.debug:
        var: imap_assign.status
      when: not use_existing_blueprint | bool

    # ── Set test variables based on run mode ──────────────────────────

    - name: Set test variables (standalone mode - vQFX defaults)
      ansible.builtin.set_fact:
        test_leaf_id: "{{ leaf_ids[0] }}"
        test_if_name_1: "xe-0/0/7"
        test_if_name_2: "xe-0/0/8"
        test_if_name_3: "xe-0/0/9"
        test_if_name_4: "xe-0/0/10"
        test_if_transform_id: 1
      when: not use_existing_blueprint | bool

    - name: Set test variables (existing blueprint mode - user-provided)
      ansible.builtin.set_fact:
        test_leaf_id: "{{ leaf_switch_id }}"
        test_if_name_1: "{{ if_name_1 }}"
        test_if_name_2: "{{ if_name_2 }}"
        test_if_name_3: "{{ if_name_3 }}"
        test_if_name_4: "{{ if_name_4 }}"
        test_if_transform_id: "{{ if_transform_id }}"
      when: use_existing_blueprint | bool

    - name: Display test variables
      ansible.builtin.debug:
        msg: >-
          leaf={{ test_leaf_id }},
          if1={{ test_if_name_1 }}, if2={{ test_if_name_2 }},
          if3={{ test_if_name_3 }}, if4={{ test_if_name_4 }},
          transform={{ test_if_transform_id }}

    # ══════════════════════════════════════════════════════════════════
    #  TEST 1: Create generic system with a single link
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 1 - Create generic system with a single link"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-gs-tf-001"
        hostname: "test-gs-tf-001"
        tags:
          - "server"
          - "test"
        deploy_mode: "deploy"
        links:
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_1 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
            tags:
              - "10G"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_create

    - name: Display created generic system
      ansible.builtin.debug:
        var: gs_create

    - name: Verify generic system was created
      ansible.builtin.assert:
        that:
          - gs_create.changed
          - gs_create.system_id is defined
          - gs_create.blueprint_id == blueprint_id
          - gs_create.links | length > 0
          - gs_create.msg == "generic system created successfully"
        fail_msg: "TEST 1 FAILED: Generic system creation"
        success_msg: "TEST 1 PASSED: Generic system created"

    - name: Save system ID
      ansible.builtin.set_fact:
        gs_system_id: "{{ gs_create.system_id }}"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 2: Create idempotency (same name should not change)
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 2 - Create same generic system again (idempotency)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-gs-tf-001"
        hostname: "test-gs-tf-001"
        tags:
          - "server"
          - "test"
        deploy_mode: "deploy"
        links:
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_1 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
            tags:
              - "10G"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_create_idem

    - name: Display create idempotency result
      ansible.builtin.debug:
        var: gs_create_idem

    - name: Verify create idempotency
      ansible.builtin.assert:
        that:
          - not gs_create_idem.changed
        fail_msg: "TEST 2 FAILED: Create idempotency"
        success_msg: "TEST 2 PASSED: Create idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 3: Update hostname and name
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 3 - Update generic system hostname and name"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ gs_system_id }}"
        name: "test-gs-tf-001-updated"
        hostname: "test-gs-tf-001-updated"
        tags:
          - "server"
          - "test"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_update

    - name: Display update result
      ansible.builtin.debug:
        var: gs_update

    - name: Verify generic system was updated
      ansible.builtin.assert:
        that:
          - gs_update.changed
          - gs_update.changes is defined
          - gs_update.hostname == "test-gs-tf-001-updated"
          - gs_update.name == "test-gs-tf-001-updated"
        fail_msg: "TEST 3 FAILED: Generic system update"
        success_msg: "TEST 3 PASSED: Generic system updated"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 4: Update idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 4 - Update with same values (idempotency)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ gs_system_id }}"
        name: "test-gs-tf-001-updated"
        hostname: "test-gs-tf-001-updated"
        tags:
          - "server"
          - "test"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_update_idem

    - name: Display update idempotency result
      ansible.builtin.debug:
        var: gs_update_idem

    - name: Verify update idempotency
      ansible.builtin.assert:
        that:
          - not gs_update_idem.changed
        fail_msg: "TEST 4 FAILED: Update idempotency"
        success_msg: "TEST 4 PASSED: Update idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 5: Update deploy mode
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 5 - Change deploy mode to ready"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ gs_system_id }}"
        deploy_mode: "ready"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_deploy_mode

    - name: Display deploy mode update result
      ansible.builtin.debug:
        var: gs_deploy_mode

    - name: Verify deploy mode was updated
      ansible.builtin.assert:
        that:
          - gs_deploy_mode.changed
          - gs_deploy_mode.deploy_mode == "ready"
        fail_msg: "TEST 5 FAILED: Deploy mode update"
        success_msg: "TEST 5 PASSED: Deploy mode updated to ready"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 6: Update tags
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 6 - Update tags"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ gs_system_id }}"
        tags:
          - "server"
          - "test"
          - "updated"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_tags_update

    - name: Display tags update result
      ansible.builtin.debug:
        var: gs_tags_update

    - name: Verify tags were updated
      ansible.builtin.assert:
        that:
          - gs_tags_update.changed
          - "'updated' in gs_tags_update.tags"
        fail_msg: "TEST 6 FAILED: Tags update"
        success_msg: "TEST 6 PASSED: Tags updated"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 7: Delete generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 7 - Delete generic system"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ gs_system_id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: gs_delete

    - name: Display delete result
      ansible.builtin.debug:
        var: gs_delete

    - name: Verify generic system was deleted
      ansible.builtin.assert:
        that:
          - gs_delete.changed
        fail_msg: "TEST 7 FAILED: Generic system deletion"
        success_msg: "TEST 7 PASSED: Generic system deleted"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 8: Delete idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 8 - Delete same system again (idempotency)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ gs_system_id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: gs_delete_idem

    - name: Display delete idempotency result
      ansible.builtin.debug:
        var: gs_delete_idem

    - name: Verify delete idempotency
      ansible.builtin.assert:
        that:
          - not gs_delete_idem.changed
        fail_msg: "TEST 8 FAILED: Delete idempotency"
        success_msg: "TEST 8 PASSED: Delete idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 9: Create generic system with dual LAG links
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 9 - Create generic system with dual LAG links"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-lag-server-tf"
        hostname: "test-lag-server-tf"
        tags:
          - "server"
          - "lag"
        links:
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_2 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
            lag_mode: "lacp_active"
            group_label: "bond0"
            tags: ["10G", "bond0"]
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_3 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
            lag_mode: "lacp_active"
            group_label: "bond0"
            tags: ["10G", "bond0"]
        state: present
        auth_token: "{{ auth.token }}"
      register: lag_gs_create

    - name: Display LAG generic system result
      ansible.builtin.debug:
        var: lag_gs_create

    - name: Verify LAG generic system was created
      ansible.builtin.assert:
        that:
          - lag_gs_create.changed
          - lag_gs_create.links | length == 2
          - lag_gs_create.system_id is defined
        fail_msg: "TEST 9 FAILED: LAG generic system creation"
        success_msg: "TEST 9 PASSED: LAG generic system created with 2 links"

    - name: Save LAG system ID
      ansible.builtin.set_fact:
        lag_system_id: "{{ lag_gs_create.system_id }}"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 10: LAG create idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 10 - Create same LAG system again (idempotency)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-lag-server-tf"
        hostname: "test-lag-server-tf"
        tags:
          - "server"
          - "lag"
        links:
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_2 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
            lag_mode: "lacp_active"
            group_label: "bond0"
            tags: ["10G", "bond0"]
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_3 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
            lag_mode: "lacp_active"
            group_label: "bond0"
            tags: ["10G", "bond0"]
        state: present
        auth_token: "{{ auth.token }}"
      register: lag_gs_idem

    - name: Verify LAG create idempotency
      ansible.builtin.assert:
        that:
          - not lag_gs_idem.changed
        fail_msg: "TEST 10 FAILED: LAG create idempotency"
        success_msg: "TEST 10 PASSED: LAG create idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 11: Delete LAG generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 11 - Delete LAG generic system"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ lag_system_id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: lag_gs_delete

    - name: Display LAG delete result
      ansible.builtin.debug:
        var: lag_gs_delete

    - name: Verify LAG generic system was deleted
      ansible.builtin.assert:
        that:
          - lag_gs_delete.changed
        fail_msg: "TEST 11 FAILED: LAG generic system deletion"
        success_msg: "TEST 11 PASSED: LAG generic system deleted"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 12: Create external generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 12 - Create external generic system"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-ext-gs-tf"
        hostname: "test-ext-gs-tf"
        external: true
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_create

    - name: Display external GS result
      ansible.builtin.debug:
        var: ext_gs_create

    - name: Verify external GS was created
      ansible.builtin.assert:
        that:
          - ext_gs_create.changed
          - ext_gs_create.system_id is defined
        fail_msg: "TEST 12 FAILED: External GS creation"
        success_msg: "TEST 12 PASSED: External GS created"

    - name: Save external system ID
      ansible.builtin.set_fact:
        ext_system_id: "{{ ext_gs_create.system_id }}"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 13: External GS create idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 13 - Create same external GS again (idempotency)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-ext-gs-tf"
        hostname: "test-ext-gs-tf"
        external: true
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_idem

    - name: Verify external GS create idempotency
      ansible.builtin.assert:
        that:
          - not ext_gs_idem.changed
        fail_msg: "TEST 13 FAILED: External GS create idempotency"
        success_msg: "TEST 13 PASSED: External GS create idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 14: Update external GS hostname
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 14 - Update external GS hostname"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ ext_system_id }}"
        name: "test-ext-gs-tf-updated"
        hostname: "test-ext-gs-tf-updated"
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_update

    - name: Display external GS update result
      ansible.builtin.debug:
        var: ext_gs_update

    - name: Verify external GS was updated
      ansible.builtin.assert:
        that:
          - ext_gs_update.changed
          - ext_gs_update.hostname == "test-ext-gs-tf-updated"
        fail_msg: "TEST 14 FAILED: External GS update"
        success_msg: "TEST 14 PASSED: External GS updated"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 15: External GS update idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 15 - Update external GS with same values (idempotency)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ ext_system_id }}"
        name: "test-ext-gs-tf-updated"
        hostname: "test-ext-gs-tf-updated"
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_update_idem

    - name: Verify external GS update idempotency
      ansible.builtin.assert:
        that:
          - not ext_gs_update_idem.changed
        fail_msg: "TEST 15 FAILED: External GS update idempotency"
        success_msg: "TEST 15 PASSED: External GS update idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 16: Delete external GS
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 16 - Delete external GS"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ ext_system_id }}"
        external: true
        state: absent
        auth_token: "{{ auth.token }}"
      register: ext_gs_delete

    - name: Display external GS delete result
      ansible.builtin.debug:
        var: ext_gs_delete

    - name: Verify external GS was deleted
      ansible.builtin.assert:
        that:
          - ext_gs_delete.changed
        fail_msg: "TEST 16 FAILED: External GS deletion"
        success_msg: "TEST 16 PASSED: External GS deleted"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 17: External GS delete idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 17 - Delete same external GS again (idempotency)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        system_id: "{{ ext_system_id }}"
        external: true
        state: absent
        auth_token: "{{ auth.token }}"
      register: ext_gs_delete_idem

    - name: Verify external GS delete idempotency
      ansible.builtin.assert:
        that:
          - not ext_gs_delete_idem.changed
        fail_msg: "TEST 17 FAILED: External GS delete idempotency"
        success_msg: "TEST 17 PASSED: External GS delete idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 18: Delete by name (no system_id provided)
    # ══════════════════════════════════════════════════════════════════

    - name: Create generic system for name-based deletion test
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-gs-delete-by-name"
        hostname: "test-gs-delete-by-name"
        links:
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_4 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_for_name_delete

    - name: "TEST 18 - Delete generic system by name"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "test-gs-delete-by-name"
        state: absent
        auth_token: "{{ auth.token }}"
      register: gs_name_delete

    - name: Display name-based delete result
      ansible.builtin.debug:
        var: gs_name_delete

    - name: Verify name-based deletion
      ansible.builtin.assert:
        that:
          - gs_name_delete.changed
        fail_msg: "TEST 18 FAILED: Name-based deletion"
        success_msg: "TEST 18 PASSED: Generic system deleted by name"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 19-20: Validation / Error handling
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 19 - Create without links or external (should fail)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "should-fail-no-links"
        hostname: "should-fail-no-links"
        state: present
        auth_token: "{{ auth.token }}"
      register: no_links_result
      ignore_errors: true

    - name: Verify missing links error
      ansible.builtin.assert:
        that:
          - no_links_result is failed
        fail_msg: "TEST 19 FAILED: Should have failed without links"
        success_msg: "TEST 19 PASSED: Missing links error caught"

    - name: "TEST 20 - Duplicate link endpoints (should fail)"
      juniper.apstra.generic_systems:
        blueprint_id: "{{ blueprint_id }}"
        name: "should-fail-dup-links"
        hostname: "should-fail-dup-links"
        links:
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_1 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
          - target_switch_id: "{{ test_leaf_id }}"
            target_switch_if_name: "{{ test_if_name_1 }}"
            target_switch_if_transform_id: "{{ test_if_transform_id }}"
        state: present
        auth_token: "{{ auth.token }}"
      register: dup_links_result
      ignore_errors: true

    - name: Verify duplicate link error
      ansible.builtin.assert:
        that:
          - dup_links_result is failed
        fail_msg: "TEST 20 FAILED: Should have failed with duplicate links"
        success_msg: "TEST 20 PASSED: Duplicate link error caught"

    # ══════════════════════════════════════════════════════════════════
    #  Cleanup
    # ══════════════════════════════════════════════════════════════════

    - name: Unlock the blueprint
      juniper.apstra.blueprint:
        id: "{{ bp.id }}"
        lock_state: "unlocked"
        auth_token: "{{ auth.token }}"
      register: blueprint_unlock
      when: not use_existing_blueprint | bool

    - name: Show unlocked blueprint
      ansible.builtin.debug:
        var: blueprint_unlock
      when: not use_existing_blueprint | bool

    - name: Delete blueprint
      juniper.apstra.blueprint:
        id: "{{ bp.id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: blueprint_delete
      when: not use_existing_blueprint | bool

    - name: Show deleted blueprint
      ansible.builtin.debug:
        var: blueprint_delete
      when: not use_existing_blueprint | bool

    - name: Logout of Apstra
      juniper.apstra.authenticate:
        logout: true
        auth_token: "{{ auth.token }}"
