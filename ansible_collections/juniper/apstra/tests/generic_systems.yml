---
- name: Test generic_systems CRUD operations (switch-system-links + external)
  hosts: localhost
  gather_facts: false
  connection: local
  vars:
    apstra_api_url: "{{ lookup('env', 'APSTRA_API_URL') }}"
  tasks:
    - name: Get local hostname
      ansible.builtin.command: hostname
      register: local_hostname
      changed_when: false

    - name: Set blueprint name fact
      ansible.builtin.set_fact:
        blueprint_name: "test_generic_systems_{{ local_hostname.stdout }}"

    - name: Connect to Apstra
      juniper.apstra.authenticate:
        logout: false
      register: auth

    # ══════════════════════════════════════════════════════════════════
    #  Blueprint Setup
    # ══════════════════════════════════════════════════════════════════

    - name: Create blueprint
      juniper.apstra.blueprint:
        body:
          label: "{{ blueprint_name }}"
          design: "two_stage_l3clos"
          init_type: "template_reference"
          template_id: "L2_Virtual_EVPN"
        lock_state: "ignore"
        auth_token: "{{ auth.token }}"
      register: bp

    - name: Show created blueprint
      ansible.builtin.debug:
        var: bp

    - name: Set blueprint_id fact
      ansible.builtin.set_fact:
        blueprint_id: "{{ bp.id.blueprint }}"

    # ── Discover leaves and assign interface maps ─────────────────────
    # Leaves must have interface maps assigned before switch-system-links
    # can be created.  We use QE to find leaves, then assign interface
    # maps via the REST API.

    - name: Query leaves via QE
      ansible.builtin.uri:
        url: "{{ apstra_api_url }}/blueprints/{{ blueprint_id }}/qe"
        method: POST
        headers:
          AuthToken: "{{ auth.token }}"
        body_format: json
        body:
          query: "node('system', role='leaf', name='leaf')"
        validate_certs: false
        status_code: 200
      register: leaves_qe

    - name: Extract leaf IDs
      ansible.builtin.set_fact:
        leaf_ids: "{{ leaves_qe.json['items'] | map(attribute='leaf') | map(attribute='id') | list }}"

    - name: Display leaf IDs
      ansible.builtin.debug:
        msg: "Found {{ leaf_ids | length }} leaves: {{ leaf_ids }}"

    - name: Use first leaf for testing
      ansible.builtin.set_fact:
        test_leaf_id: "{{ leaf_ids[0] }}"

    # Assign interface map to the first leaf
    - name: Build interface map assignment body
      ansible.builtin.set_fact:
        imap_body:
          assignments: "{{ {test_leaf_id: 'Juniper_vQFX__AOS-7x10-Leaf'} }}"

    - name: Assign interface map to test leaf
      ansible.builtin.uri:
        url: "{{ apstra_api_url }}/blueprints/{{ blueprint_id }}/interface-map-assignments"
        method: PATCH
        headers:
          AuthToken: "{{ auth.token }}"
        body_format: json
        body: "{{ imap_body }}"
        validate_certs: false
        status_code: [200, 202, 204]
      register: imap_assign

    - name: Display interface map assignment result
      ansible.builtin.debug:
        var: imap_assign.status

    # ── Discover existing generic systems (from template) ─────────────

    - name: Get blueprint nodes to find existing generic systems
      juniper.apstra.apstra_facts:
        gather_network_facts:
          - "blueprints.nodes"
        id:
          blueprint: "{{ blueprint_id }}"
        filter:
          blueprints.nodes: "node_type=system"
        auth_token: "{{ auth.token }}"
      register: bp_facts

    - name: Extract generic system IDs from blueprint facts
      ansible.builtin.set_fact:
        generic_systems: >-
          {{ bp_facts.ansible_facts.apstra_facts.blueprints[blueprint_id].nodes
             | dict2items
             | selectattr('value.role', 'equalto', 'generic')
             | map(attribute='value')
             | list }}

    - name: Display discovered generic systems
      ansible.builtin.debug:
        msg: "Found {{ generic_systems | length }} generic systems from template"

    - name: Set first generic system ID for update/delete tests
      ansible.builtin.set_fact:
        existing_gs_id: "{{ generic_systems[0].id }}"
        existing_gs_label: "{{ generic_systems[0].label }}"
        existing_gs_hostname: "{{ generic_systems[0].hostname }}"

    - name: Display test generic system
      ansible.builtin.debug:
        msg: "Template GS for testing: {{ existing_gs_id }} ({{ existing_gs_label }})"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 1: Create generic system via switch-system-links
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 1 - Create generic system via switch-system-links"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        body:
          links:
            - lag_mode: null
              switch:
                system_id: "{{ test_leaf_id }}"
                transformation_id: 1
                if_name: "xe-0/0/7"
              system:
                system_id: null
              new_system_index: 0
          new_systems:
            - system_type: "server"
              hostname: "test-gs-001"
              label: "test-gs-001"
              deploy_mode: "deploy"
              logical_device:
                id: "AOS-1x10-1"
                display_name: "AOS-1x10-1"
                panels:
                  - port_groups:
                      - roles:
                          - "leaf"
                          - "access"
                        count: 1
                        speed:
                          value: 10
                          unit: "G"
                    port_indexing:
                      schema: "absolute"
                      order: "T-B, L-R"
                      start_index: 1
                    panel_layout:
                      row_count: 1
                      column_count: 1
              port_channel_id_min: 0
              port_channel_id_max: 0
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_create

    - name: Display created generic system
      ansible.builtin.debug:
        var: gs_create

    - name: Verify generic system was created
      ansible.builtin.assert:
        that:
          - gs_create.changed
          - gs_create.id.blueprint is defined
          - gs_create.links | length > 0
          - gs_create.msg == "generic system created successfully"
        fail_msg: "TEST 1 FAILED: Generic system creation"
        success_msg: "TEST 1 PASSED: Generic system created"

    - name: Save created generic system ID
      ansible.builtin.set_fact:
        new_gs_id: "{{ gs_create.id.generic_system }}"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 2: Create idempotency (same label should not change)
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 2 - Create same generic system again (idempotency)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        body:
          links:
            - lag_mode: null
              switch:
                system_id: "{{ test_leaf_id }}"
                transformation_id: 1
                if_name: "xe-0/0/7"
              system:
                system_id: null
              new_system_index: 0
          new_systems:
            - system_type: "server"
              hostname: "test-gs-001"
              label: "test-gs-001"
              deploy_mode: "deploy"
              logical_device:
                id: "AOS-1x10-1"
                display_name: "AOS-1x10-1"
                panels:
                  - port_groups:
                      - roles:
                          - "leaf"
                          - "access"
                        count: 1
                        speed:
                          value: 10
                          unit: "G"
                    port_indexing:
                      schema: "absolute"
                      order: "T-B, L-R"
                      start_index: 1
                    panel_layout:
                      row_count: 1
                      column_count: 1
              port_channel_id_min: 0
              port_channel_id_max: 0
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_create_idem

    - name: Display create idempotency result
      ansible.builtin.debug:
        var: gs_create_idem

    - name: Verify create idempotency
      ansible.builtin.assert:
        that:
          - not gs_create_idem.changed
        fail_msg: "TEST 2 FAILED: Create idempotency"
        success_msg: "TEST 2 PASSED: Create idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 3: Update generic system (hostname + label)
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 3 - Update generic system hostname and label"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ new_gs_id }}"
        body:
          hostname: "test-gs-001-updated"
          label: "test-gs-001-updated"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_update

    - name: Display update result
      ansible.builtin.debug:
        var: gs_update

    - name: Verify generic system was updated
      ansible.builtin.assert:
        that:
          - gs_update.changed
          - gs_update.changes is defined
          - gs_update.generic_system.hostname == "test-gs-001-updated"
        fail_msg: "TEST 3 FAILED: Generic system update"
        success_msg: "TEST 3 PASSED: Generic system updated"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 4: Update idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 4 - Update with same values (idempotency)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ new_gs_id }}"
        body:
          hostname: "test-gs-001-updated"
          label: "test-gs-001-updated"
        state: present
        auth_token: "{{ auth.token }}"
      register: gs_update_idem

    - name: Display update idempotency result
      ansible.builtin.debug:
        var: gs_update_idem

    - name: Verify update idempotency
      ansible.builtin.assert:
        that:
          - not gs_update_idem.changed
        fail_msg: "TEST 4 FAILED: Update idempotency"
        success_msg: "TEST 4 PASSED: Update idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 5: Delete generic system (remove all links)
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 5 - Delete generic system"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ new_gs_id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: gs_delete

    - name: Display delete result
      ansible.builtin.debug:
        var: gs_delete

    - name: Verify generic system was deleted
      ansible.builtin.assert:
        that:
          - gs_delete.changed
        fail_msg: "TEST 5 FAILED: Generic system deletion"
        success_msg: "TEST 5 PASSED: Generic system deleted"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 6: Delete idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 6 - Delete same generic system again (idempotency)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ new_gs_id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: gs_delete_idem

    - name: Display delete idempotency result
      ansible.builtin.debug:
        var: gs_delete_idem

    - name: Verify delete idempotency
      ansible.builtin.assert:
        that:
          - not gs_delete_idem.changed
        fail_msg: "TEST 6 FAILED: Delete idempotency"
        success_msg: "TEST 6 PASSED: Delete idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 7: Update template-provided generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 7 - Update existing template generic system"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ existing_gs_id }}"
        body:
          hostname: "updated-template-gs"
          label: "updated-template-gs"
        state: present
        auth_token: "{{ auth.token }}"
      register: template_gs_update

    - name: Display template GS update result
      ansible.builtin.debug:
        var: template_gs_update

    - name: Verify template GS was updated
      ansible.builtin.assert:
        that:
          - template_gs_update.changed
        fail_msg: "TEST 7 FAILED: Template GS update"
        success_msg: "TEST 7 PASSED: Template GS updated"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 8: Update template GS idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 8 - Update template GS with same values (idempotency)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ existing_gs_id }}"
        body:
          hostname: "updated-template-gs"
          label: "updated-template-gs"
        state: present
        auth_token: "{{ auth.token }}"
      register: template_gs_idem

    - name: Display template GS update idempotency
      ansible.builtin.debug:
        var: template_gs_idem

    - name: Verify template GS update idempotency
      ansible.builtin.assert:
        that:
          - not template_gs_idem.changed
        fail_msg: "TEST 8 FAILED: Template GS update idempotency"
        success_msg: "TEST 8 PASSED: Template GS update idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 9: Restore template GS to original values
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 9 - Restore template GS to original values"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ existing_gs_id }}"
        body:
          hostname: "{{ existing_gs_hostname }}"
          label: "{{ existing_gs_label }}"
        state: present
        auth_token: "{{ auth.token }}"
      register: template_gs_restore

    - name: Verify template GS restored
      ansible.builtin.assert:
        that:
          - template_gs_restore.changed
        fail_msg: "TEST 9 FAILED: Template GS restore"
        success_msg: "TEST 9 PASSED: Template GS restored"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 10: Delete template GS (via link removal)
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 10 - Delete template generic system"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ existing_gs_id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: template_gs_delete

    - name: Display template GS delete result
      ansible.builtin.debug:
        var: template_gs_delete

    - name: Verify template GS was deleted
      ansible.builtin.assert:
        that:
          - template_gs_delete.changed
        fail_msg: "TEST 10 FAILED: Template GS deletion"
        success_msg: "TEST 10 PASSED: Template GS deleted"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 11: Create external generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 11 - Create external generic system"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        body:
          external: true
          hostname: "test-ext-gs-001"
          label: "test-ext-gs-001"
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_create

    - name: Display created external GS
      ansible.builtin.debug:
        var: ext_gs_create

    - name: Verify external GS was created
      ansible.builtin.assert:
        that:
          - ext_gs_create.changed
          - ext_gs_create.id.blueprint is defined
          - ext_gs_create.id.generic_system is defined
        fail_msg: "TEST 11 FAILED: External GS creation"
        success_msg: "TEST 11 PASSED: External GS created"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 12: External GS create idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 12 - Create same external GS again (idempotency)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        body:
          external: true
          hostname: "test-ext-gs-001"
          label: "test-ext-gs-001"
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_idem

    - name: Display external GS idempotency result
      ansible.builtin.debug:
        var: ext_gs_idem

    - name: Verify external GS create idempotency
      ansible.builtin.assert:
        that:
          - not ext_gs_idem.changed
        fail_msg: "TEST 12 FAILED: External GS create idempotency"
        success_msg: "TEST 12 PASSED: External GS create idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 13: Update external generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 13 - Update external GS hostname"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ ext_gs_create.id.generic_system }}"
        body:
          external: true
          hostname: "test-ext-gs-updated"
          label: "test-ext-gs-updated"
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_update

    - name: Display external GS update result
      ansible.builtin.debug:
        var: ext_gs_update

    - name: Verify external GS was updated
      ansible.builtin.assert:
        that:
          - ext_gs_update.changed
        fail_msg: "TEST 13 FAILED: External GS update"
        success_msg: "TEST 13 PASSED: External GS updated"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 14: External GS update idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 14 - Update external GS with same values (idempotency)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ ext_gs_create.id.generic_system }}"
        body:
          external: true
          hostname: "test-ext-gs-updated"
          label: "test-ext-gs-updated"
        state: present
        auth_token: "{{ auth.token }}"
      register: ext_gs_update_idem

    - name: Display external GS update idempotency
      ansible.builtin.debug:
        var: ext_gs_update_idem

    - name: Verify external GS update idempotency
      ansible.builtin.assert:
        that:
          - not ext_gs_update_idem.changed
        fail_msg: "TEST 14 FAILED: External GS update idempotency"
        success_msg: "TEST 14 PASSED: External GS update idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 15: Delete external generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 15 - Delete external GS"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ ext_gs_create.id.generic_system }}"
        body:
          external: true
        state: absent
        auth_token: "{{ auth.token }}"
      register: ext_gs_delete

    - name: Display external GS delete result
      ansible.builtin.debug:
        var: ext_gs_delete

    - name: Verify external GS was deleted
      ansible.builtin.assert:
        that:
          - ext_gs_delete.changed
        fail_msg: "TEST 15 FAILED: External GS deletion"
        success_msg: "TEST 15 PASSED: External GS deleted"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 16: External GS delete idempotency
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 16 - Delete same external GS again (idempotency)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ ext_gs_create.id.generic_system }}"
        body:
          external: true
        state: absent
        auth_token: "{{ auth.token }}"
      register: ext_gs_delete_idem

    - name: Display external GS delete idempotency
      ansible.builtin.debug:
        var: ext_gs_delete_idem

    - name: Verify external GS delete idempotency
      ansible.builtin.assert:
        that:
          - not ext_gs_delete_idem.changed
        fail_msg: "TEST 16 FAILED: External GS delete idempotency"
        success_msg: "TEST 16 PASSED: External GS delete idempotency - no change"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 17: Create generic system with LAG links
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 17 - Create generic system with dual LAG links"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        body:
          links:
            - lag_mode: "lacp_active"
              link_group_label: "server-lag"
              switch:
                system_id: "{{ test_leaf_id }}"
                transformation_id: 1
                if_name: "xe-0/0/8"
              system:
                system_id: null
              new_system_index: 0
            - lag_mode: "lacp_active"
              link_group_label: "server-lag"
              switch:
                system_id: "{{ test_leaf_id }}"
                transformation_id: 1
                if_name: "xe-0/0/9"
              system:
                system_id: null
              new_system_index: 0
          new_systems:
            - system_type: "server"
              hostname: "test-lag-server"
              label: "test-lag-server"
              deploy_mode: "deploy"
              logical_device:
                id: "AOS-2x10-1"
                display_name: "AOS-2x10-1"
                panels:
                  - port_groups:
                      - roles:
                          - "leaf"
                          - "access"
                        count: 2
                        speed:
                          value: 10
                          unit: "G"
                    port_indexing:
                      schema: "absolute"
                      order: "T-B, L-R"
                      start_index: 1
                    panel_layout:
                      row_count: 1
                      column_count: 2
              port_channel_id_min: 0
              port_channel_id_max: 0
        state: present
        auth_token: "{{ auth.token }}"
      register: lag_gs_create

    - name: Display LAG generic system result
      ansible.builtin.debug:
        var: lag_gs_create

    - name: Verify LAG generic system was created
      ansible.builtin.assert:
        that:
          - lag_gs_create.changed
          - lag_gs_create.links | length == 2
        fail_msg: "TEST 17 FAILED: LAG generic system creation"
        success_msg: "TEST 17 PASSED: LAG generic system created with 2 links"

    - name: Save LAG generic system ID
      ansible.builtin.set_fact:
        lag_gs_id: "{{ lag_gs_create.id.generic_system }}"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 18: Delete LAG generic system
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 18 - Delete LAG generic system"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
          generic_system: "{{ lag_gs_id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: lag_gs_delete

    - name: Display LAG GS delete result
      ansible.builtin.debug:
        var: lag_gs_delete

    - name: Verify LAG GS was deleted
      ansible.builtin.assert:
        that:
          - lag_gs_delete.changed
        fail_msg: "TEST 18 FAILED: LAG GS deletion"
        success_msg: "TEST 18 PASSED: LAG GS deleted"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 19: Delete by label (via absent + body.label)
    # ══════════════════════════════════════════════════════════════════

    # First, create a system to delete by label
    - name: Create generic system for label-based deletion test
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        body:
          links:
            - lag_mode: null
              switch:
                system_id: "{{ test_leaf_id }}"
                transformation_id: 1
                if_name: "xe-0/0/10"
              system:
                system_id: null
              new_system_index: 0
          new_systems:
            - system_type: "server"
              hostname: "test-gs-for-label-delete"
              label: "test-gs-for-label-delete"
              deploy_mode: "deploy"
              logical_device:
                id: "AOS-1x10-1"
                display_name: "AOS-1x10-1"
                panels:
                  - port_groups:
                      - roles:
                          - "leaf"
                          - "access"
                        count: 1
                        speed:
                          value: 10
                          unit: "G"
                    port_indexing:
                      schema: "absolute"
                      order: "T-B, L-R"
                      start_index: 1
                    panel_layout:
                      row_count: 1
                      column_count: 1
              port_channel_id_min: 0
              port_channel_id_max: 0
        state: present
        auth_token: "{{ auth.token }}"
      register: label_delete_gs

    - name: "TEST 19 - Delete generic system by label"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        body:
          label: "test-gs-for-label-delete"
        state: absent
        auth_token: "{{ auth.token }}"
      register: label_delete_result

    - name: Display label delete result
      ansible.builtin.debug:
        var: label_delete_result

    - name: Verify label-based deletion
      ansible.builtin.assert:
        that:
          - label_delete_result.changed
        fail_msg: "TEST 19 FAILED: Label-based deletion"
        success_msg: "TEST 19 PASSED: Generic system deleted by label"

    # ══════════════════════════════════════════════════════════════════
    #  TEST 20-21: Validation / Error handling
    # ══════════════════════════════════════════════════════════════════

    - name: "TEST 20 - Missing blueprint ID (should fail)"
      juniper.apstra.generic_systems:
        id: {}
        body:
          external: true
          hostname: "should-fail"
          label: "should-fail"
        auth_token: "{{ auth.token }}"
      register: no_bp_result
      ignore_errors: true

    - name: Verify missing blueprint error
      ansible.builtin.assert:
        that:
          - no_bp_result is failed
        fail_msg: "TEST 20 FAILED: Should have failed with missing blueprint"
        success_msg: "TEST 20 PASSED: Missing blueprint error caught"

    - name: "TEST 21 - Missing body for create (should fail)"
      juniper.apstra.generic_systems:
        id:
          blueprint: "{{ blueprint_id }}"
        state: present
        auth_token: "{{ auth.token }}"
      register: no_body_result
      ignore_errors: true

    - name: Verify missing body error
      ansible.builtin.assert:
        that:
          - no_body_result is failed
        fail_msg: "TEST 21 FAILED: Should have failed with missing body"
        success_msg: "TEST 21 PASSED: Missing body error caught"

    # ══════════════════════════════════════════════════════════════════
    #  Cleanup
    # ══════════════════════════════════════════════════════════════════

    - name: Unlock the blueprint
      juniper.apstra.blueprint:
        id: "{{ bp.id }}"
        lock_state: "unlocked"
        auth_token: "{{ auth.token }}"
      register: blueprint_unlock

    - name: Show unlocked blueprint
      ansible.builtin.debug:
        var: blueprint_unlock

    - name: Delete blueprint
      juniper.apstra.blueprint:
        id: "{{ bp.id }}"
        state: absent
        auth_token: "{{ auth.token }}"
      register: blueprint_delete

    - name: Show deleted blueprint
      ansible.builtin.debug:
        var: blueprint_delete

    - name: Logout of Apstra
      juniper.apstra.authenticate:
        logout: true
        auth_token: "{{ auth.token }}"
