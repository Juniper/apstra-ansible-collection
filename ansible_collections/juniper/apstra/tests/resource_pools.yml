- name: Test resource pools CRUD operations
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:
    - name: Authenticate with Apstra
      juniper.apstra.authenticate:
        logout: false
      register: auth_result

    # ── ASN Pool Tests ──────────────────────────────────────────────────

    - name: Create ASN pool
      juniper.apstra.resource_pools:
        type: asn
        body:
          display_name: "test_asn_pool"
          ranges:
            - first: 65000
              last: 65050
        auth_token: "{{ auth_result.token }}"
      register: asn_create

    - name: Display created ASN pool
      ansible.builtin.debug:
        var: asn_create

    - name: Create same ASN pool again (should not change)
      juniper.apstra.resource_pools:
        type: asn
        body:
          display_name: "test_asn_pool"
          ranges:
            - first: 65000
              last: 65050
        auth_token: "{{ auth_result.token }}"
      register: asn_no_change

    - name: Verify ASN pool no change occurred
      ansible.builtin.assert:
        that:
          - not asn_no_change.changed

    - name: Update ASN pool
      juniper.apstra.resource_pools:
        type: asn
        id: "{{ asn_create.id }}"
        body:
          display_name: "test_asn_pool_updated"
          ranges:
            - first: 65000
              last: 65100
        auth_token: "{{ auth_result.token }}"
      register: asn_update

    - name: Display updated ASN pool
      ansible.builtin.debug:
        var: asn_update

    - name: Delete ASN pool
      juniper.apstra.resource_pools:
        type: asn
        id: "{{ asn_create.id }}"
        state: absent
        auth_token: "{{ auth_result.token }}"
      register: asn_delete

    - name: Display ASN pool deletion result
      ansible.builtin.debug:
        var: asn_delete

    # ── IP Pool Tests ───────────────────────────────────────────────────

    - name: Create IP pool
      juniper.apstra.resource_pools:
        type: ip
        body:
          display_name: "test_ip_pool"
          subnets:
            - network: "10.100.0.0/24"
        auth_token: "{{ auth_result.token }}"
      register: ip_create

    - name: Display created IP pool
      ansible.builtin.debug:
        var: ip_create

    - name: Create same IP pool again (should not change)
      juniper.apstra.resource_pools:
        type: ip
        body:
          display_name: "test_ip_pool"
          subnets:
            - network: "10.100.0.0/24"
        auth_token: "{{ auth_result.token }}"
      register: ip_no_change

    - name: Verify IP pool no change occurred
      ansible.builtin.assert:
        that:
          - not ip_no_change.changed

    - name: Update IP pool
      juniper.apstra.resource_pools:
        type: ip
        id: "{{ ip_create.id }}"
        body:
          display_name: "test_ip_pool_updated"
          subnets:
            - network: "10.100.0.0/24"
            - network: "10.200.0.0/24"
        auth_token: "{{ auth_result.token }}"
      register: ip_update

    - name: Display updated IP pool
      ansible.builtin.debug:
        var: ip_update

    - name: Delete IP pool
      juniper.apstra.resource_pools:
        type: ip
        id: "{{ ip_create.id }}"
        state: absent
        auth_token: "{{ auth_result.token }}"
      register: ip_delete

    - name: Display IP pool deletion result
      ansible.builtin.debug:
        var: ip_delete

    # ── VLAN Pool Tests ─────────────────────────────────────────────────

    - name: Create VLAN pool
      juniper.apstra.resource_pools:
        type: vlan
        body:
          display_name: "test_vlan_pool"
          ranges:
            - first: 100
              last: 200
        auth_token: "{{ auth_result.token }}"
      register: vlan_create

    - name: Display created VLAN pool
      ansible.builtin.debug:
        var: vlan_create

    - name: Create same VLAN pool again (should not change)
      juniper.apstra.resource_pools:
        type: vlan
        body:
          display_name: "test_vlan_pool"
          ranges:
            - first: 100
              last: 200
        auth_token: "{{ auth_result.token }}"
      register: vlan_no_change

    - name: Verify VLAN pool no change occurred
      ansible.builtin.assert:
        that:
          - not vlan_no_change.changed

    - name: Update VLAN pool
      juniper.apstra.resource_pools:
        type: vlan
        id: "{{ vlan_create.id }}"
        body:
          display_name: "test_vlan_pool_updated"
          ranges:
            - first: 100
              last: 300
        auth_token: "{{ auth_result.token }}"
      register: vlan_update

    - name: Display updated VLAN pool
      ansible.builtin.debug:
        var: vlan_update

    - name: Delete VLAN pool
      juniper.apstra.resource_pools:
        type: vlan
        id: "{{ vlan_create.id }}"
        state: absent
        auth_token: "{{ auth_result.token }}"
      register: vlan_delete

    - name: Display VLAN pool deletion result
      ansible.builtin.debug:
        var: vlan_delete

    # ── IPv6 Pool Tests ─────────────────────────────────────────────────

    - name: Create IPv6 pool
      juniper.apstra.resource_pools:
        type: ipv6
        body:
          display_name: "test_ipv6_pool"
          subnets:
            - network: "fc01:a05:fab::/48"
        auth_token: "{{ auth_result.token }}"
      register: ipv6_create

    - name: Display created IPv6 pool
      ansible.builtin.debug:
        var: ipv6_create

    - name: Create same IPv6 pool again (should not change)
      juniper.apstra.resource_pools:
        type: ipv6
        body:
          display_name: "test_ipv6_pool"
          subnets:
            - network: "fc01:a05:fab::/48"
        auth_token: "{{ auth_result.token }}"
      register: ipv6_no_change

    - name: Verify IPv6 pool no change occurred
      ansible.builtin.assert:
        that:
          - not ipv6_no_change.changed

    - name: Update IPv6 pool
      juniper.apstra.resource_pools:
        type: ipv6
        id: "{{ ipv6_create.id }}"
        body:
          display_name: "test_ipv6_pool_updated"
          subnets:
            - network: "fc01:a05:fab::/48"
            - network: "fc01:a05:fac::/48"
        auth_token: "{{ auth_result.token }}"
      register: ipv6_update

    - name: Display updated IPv6 pool
      ansible.builtin.debug:
        var: ipv6_update

    - name: Delete IPv6 pool
      juniper.apstra.resource_pools:
        type: ipv6
        id: "{{ ipv6_create.id }}"
        state: absent
        auth_token: "{{ auth_result.token }}"
      register: ipv6_delete

    - name: Display IPv6 pool deletion result
      ansible.builtin.debug:
        var: ipv6_delete

    # ── VNI Pool Tests ──────────────────────────────────────────────────

    - name: Create VNI pool
      juniper.apstra.resource_pools:
        type: vni
        body:
          display_name: "test_vni_pool"
          ranges:
            - first: 30000
              last: 31000
        auth_token: "{{ auth_result.token }}"
      register: vni_create

    - name: Display created VNI pool
      ansible.builtin.debug:
        var: vni_create

    - name: Create same VNI pool again (should not change)
      juniper.apstra.resource_pools:
        type: vni
        body:
          display_name: "test_vni_pool"
          ranges:
            - first: 30000
              last: 31000
        auth_token: "{{ auth_result.token }}"
      register: vni_no_change

    - name: Verify VNI pool no change occurred
      ansible.builtin.assert:
        that:
          - not vni_no_change.changed

    - name: Update VNI pool
      juniper.apstra.resource_pools:
        type: vni
        id: "{{ vni_create.id }}"
        body:
          display_name: "test_vni_pool_updated"
          ranges:
            - first: 30000
              last: 32000
        auth_token: "{{ auth_result.token }}"
      register: vni_update

    - name: Display updated VNI pool
      ansible.builtin.debug:
        var: vni_update

    - name: Delete VNI pool
      juniper.apstra.resource_pools:
        type: vni
        id: "{{ vni_create.id }}"
        state: absent
        auth_token: "{{ auth_result.token }}"
      register: vni_delete

    - name: Display VNI pool deletion result
      ansible.builtin.debug:
        var: vni_delete

    # ── Cleanup ─────────────────────────────────────────────────────────

    - name: Logout from Apstra
      juniper.apstra.authenticate:
        logout: true
        auth_token: "{{ auth_result.token }}"
